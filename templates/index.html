{% extends 'base.html' %}
{% block main %}
<main>
    <div class="container">
        <div class="box-center">
            <div id="box-main">
                <header class="text-center">
                    <h1> P7 Papy Bot </h1>
                    <img id="okimg" src="{{ url_for('static', filename='bot-logo-100.png') }}" />
                    <p>Salut je suis Papy Bot pose moi une question et j'irais la chercher au fin fond de mes archives</p>
                </header>

                {% include './partials/_form.html' %}

                <p id="dialog"></p>
                <div id="map"></div>
            </div>
        </div>
    </div>
</main>
{% endblock main %}

{% block javascript %}
<script>
function getdataform() {
    var h = document.getElementById("address").value;
    var data = document.getElementById("dialog");
    data.insertAdjacentHTML("beforeend", "<br>" + "<img src={{ url_for('static', filename='person-logo-50.png')}} />" + h);
};

function bot(data) {
    var p = document.getElementById("dialog");
    p.insertAdjacentHTML("beforeend", "<br>" + "<img src={{ url_for('static', filename='bot-logo-50.png')}} />" + "Bien s√ªr mon poussin ! La voici: " + data);
}

function wikiresponse(data) {
    var p = document.getElementById("dialog");
    p.insertAdjacentHTML("beforeend", "<br>" + "<img src={{ url_for('static', filename='bot-logo-50.png')}} />" + data);
}

const rotate = (image, degrees) => {
  image.style.transform = `rotate(${+degrees}deg)`;
}
const img = document.getElementById('okimg');

const oneLoop = () => {
  setTimeout(() => rotate(img, 90), 1000);
  setTimeout(() => rotate(img, 180), 2000);
  setTimeout(() => rotate(img, 360), 3000);
}

function turnbot() {
    oneLoop();
}

function loadDoc() {
  const xhttp = new XMLHttpRequest();
  xhttp.onload = function() {
    var data = document.getElementById("dialog");
    data.insertAdjacentHTML("beforeend", "<br>" + this.responseText);
  }
  xhttp.open("GET", "/wikimedia", true);
  xhttp.send();
}

$(document).ready(function() {
     $('form').on('submit', function(event) {
        turnbot();
       $.ajax({
          data : {
             address : $('#address').val(),
                 },
             type : 'POST',
             url : '/ajaxtest'
            })
        .done(function(data) {
          $('#output').text(data.output).show();
            dataApi = JSON.stringify(data.output);
            console.log(dataApi);
            setTimeout(function() {
                bot(data.output);
            }, 1000);
              $('#wikioutput').text(data.wikidata).show();
                wikiapi = JSON.stringify(data.wikidata);
                setTimeout(function() {
                    wikiresponse(data.wikidata);
            }, 2000);
                console.log(wikiapi);
          (function (geocode){
            let mapElement = 'map';
            let address = dataApi;
            geocoder = new google.maps.Geocoder();
           geocoder.geocode({ 'address': address }, function (results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
              var mapOptions = {
                  zoom: 14,
                  center: results[0].geometry.location,
                  disableDefaultUI: true
              };
              var map = new google.maps.Map(document.getElementById(mapElement), mapOptions);
              var marker = new google.maps.Marker({
                  map: map,
                  position: results[0].geometry.location
              });
            } else {
                alert("Geocode was not successful for the following reason: " + status);
            }
          });
        })();

      });
      event.preventDefault();
      });
});

</script>
{% endblock javascript %}

function geocodeAddress(geocoder, resultsMap) {
  const address = document.getElementById("address").value;
  geocoder.geocode({ address: address }, (results, status) => {
    if (status === "OK") {
      resultsMap.setCenter(results[0].geometry.location);
      new google.maps.Marker({
        map: resultsMap,
        position: results[0].geometry.location,
      });
    } else {
      alert("Geocode was not successful for the following reason: " + status);
    }
  });
}
https://maps.googleapis.com/maps/api/staticmap?center=
  "+48.90624,2.2478848+"&zoom=14&size=400x300&sensor=false&key=AIzaSyAB3wGZqVllOeyAlTzVarXmnlAOT5Kk2Eg

function initMap() {
  const map = new google.maps.Map(document.getElementById("map"), {
    zoom: 8,
    center: { lat: 48.8534, lng: 2.3488 },
  });
  const geocoder = new google.maps.Geocoder();
  document.getElementById("submit").addEventListener("click", () => {
    geocodeAddress(geocoder, map);
  });
}

<!--<a href="{{ url_for('update', id=task.id) }}">Update</a> -->
<!--<a href="{{ url_for('delete', id=task.id) }}">Delete</a> -->

var geocode = '{{ data[0] }}';
document.getElementById("geocode").innerHTML = geocode;